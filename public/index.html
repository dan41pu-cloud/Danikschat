
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#5865f2">
 <link rel="stylesheet" href="style.css">
  <title>Danikschat</title>
 
</head>
<body>

  <!-- üîä –ê–£–î–ò–û –î–õ–Ø –ó–í–£–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø -->
  <audio id="joinSound" src="join.mp3"></audio>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div id="auth" class="active">
    <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="login">–í–æ–π—Ç–∏</button>
    <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat">
    <h2 id="welcome"></h2>

    <!-- –í—ã–±–æ—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ -->
    <label for="userSelect">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ (–æ–Ω–ª–∞–π–Ω):</label>
    <select id="userSelect">
      <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
    </select>

    <ul id="messages"></ul>
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <input type="file" id="imageInput" accept="image/*" />
    <div id="emojiPicker">
      <button class="emoji">üòÄ</button>
      <button class="emoji">üòÇ</button>
      <button class="emoji">üòç</button>
      <button class="emoji">üòé</button>
      <button class="emoji">üëç</button>
    </div>

    <!-- –∫–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –≤–∏–¥–µ–æ -->
    <button id="openVideoChat">–í–∏–¥–µ–æ—á–∞—Ç</button>
  </div>

  <!-- –í–ò–î–ï–û–ß–ê–¢ -->
  <div id="videoChat">
    <h3>–í–∏–¥–µ–æ—á–∞—Ç</h3>

    <video id="localVideo" autoplay playsinline muted style="width:100%; border-radius:10px; background:black;"></video>
    <video id="remoteVideo" autoplay playsinline style="width:100%; margin-top:10px; border-radius:10px; background:black;"></video>

    <div class="controls">
      <button id="startVideo" class="vc-btn">–ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
      <button id="stopVideo" class="vc-btn danger">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
      <button id="toggleVideo" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
      <button id="toggleAudio" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º socket.io –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞ -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let allUsers = [];    // –≤—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
    let onlineUsers = []; // –∫—Ç–æ —Å–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω

    const socket = io();

    let inCall = false;
    function renderUsers() {
  const prev = userSelect.value;

  userSelect.innerHTML =
    '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>';

  allUsers.forEach(user => {
    const option = document.createElement("option");
    option.value = user;

    const online = onlineUsers.includes(user);
    option.textContent = online
      ? `${user} üü¢ –æ–Ω–ª–∞–π–Ω`
      : `${user} ‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω`;

    userSelect.appendChild(option);
  });

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
  if (prev && [...userSelect.options].some(o => o.value === prev)) {
    userSelect.value = prev;
  }
}

    const authDiv = document.getElementById('auth');
    const chatDiv = document.getElementById('chat');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const authMsg = document.getElementById('authMsg');
    const welcome = document.getElementById('welcome');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const imageInput = document.getElementById("imageInput");
    const emojiButtons = document.querySelectorAll(".emoji");
    const userSelect = document.getElementById("userSelect");

    let username = null;
    let admin = false;

    document.getElementById('register').onclick = () => {
      socket.emit('register', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };

    document.getElementById('login').onclick = () => {
      socket.emit('login', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };

    socket.on('registerSuccess', msg => authMsg.textContent = msg);
    socket.on('registerError', msg => authMsg.textContent = msg);
    socket.on('loginError', msg => authMsg.textContent = msg);

socket.on('loginSuccess', async (data) => {
  username = data.username;
  admin = data.admin;

  authDiv.classList.remove('active');
  chatDiv.classList.add('active');
  welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

  allUsers = data.users.filter(u => u !== username);
  onlineUsers = data.online;
  renderUsers();

  data.messages.forEach(addMessage);

  await subscribePush();
});

    async function subscribePush() {
  try {
    const reg = await navigator.serviceWorker.ready;

    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: "BJYi3h03X9-EdNQVsXPsKvku8G001TcpAxPgNFbvync7VlLRZnj8TgVkm-gdcpx23AmPZm7IPD0vAaSemX_MANY"
    });

    socket.emit("save-push", { username, subscription: sub });
  } catch (e) {
    console.warn("Push –æ—Ç–∫–ª—é—á—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
  }
}
  socket.on("active-users", (list) => {
  onlineUsers = list;
  renderUsers();
});
    send.onclick = () => {
      const text = input.value.trim();
      const to = userSelect.value;
      if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ.");
      if (text) {
        const msg = { from: username, to, text };
        socket.emit('chat message', msg);
        input.value = '';
      }
    };

    function addMessage(msg) {
      // msg: { from, to, text|data, time, type }
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–¥–µ –≤—ã —É—á–∞—Å—Ç–Ω–∏–∫ (—Å–µ—Ä–≤–µ—Ä —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, –Ω–æ –∏ –ø—Ä–∏—Ö–æ–¥—è—â–∏–µ ‚Äî —Ç–æ–∂–µ)
      if (!(msg.from === username || msg.to === username)) return;

      const li = document.createElement('li');
      if (msg.from === username) li.classList.add('my-message');

      const peer = msg.from === username ? msg.to : msg.from;
      const title = `${peer} (${msg.from === username ? '—è ‚Üí ' + msg.to : msg.from})`;

      if (msg.type === 'text') {
        li.innerHTML = `<div class="message-username">${title}</div><div>${escapeHtml(msg.text)}</div><div class="message-time">${msg.time}</div>`;
      } else if (msg.type === 'image') {
        li.innerHTML = `<div class="message-username">${title}</div><img src="${msg.data}" style="max-width:200px; border-radius:8px; margin-top:4px;"><div class="message-time">${msg.time}</div>`;
      }

      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on('private-message', addMessage);
    socket.on('chat-cleared', () => messages.innerHTML = '');

    emojiButtons.forEach(btn => {
      btn.onclick = () => {
        const to = userSelect.value;
        if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ.");
        socket.emit("chat message", { from: username, to, text: btn.textContent });
      };
    });

    imageInput.onchange = () => {
      const file = imageInput.files[0];
      if (!file) return;
      const to = userSelect.value;
      if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ.");
      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("chat image", { from: username, to, data: reader.result });
      };
      reader.readAsDataURL(file);
      imageInput.value = "";
    };

    /* === –í–ò–î–ï–û–ß–ê–¢ (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π) === */

    const videoChat = document.getElementById("videoChat");
    const openVideoChat = document.getElementById("openVideoChat");
    const startVideo = document.getElementById("startVideo");
    const stopVideo = document.getElementById("stopVideo");

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const toggleVideo = document.getElementById("toggleVideo");
    const toggleAudio = document.getElementById("toggleAudio");

    let localStream = null;
    let peerConnection = null;

    let iceServers = null;
    let videoEnabled = true;
    let audioEnabled = true;

    openVideoChat.onclick = () => {
      videoChat.style.display = "flex";
    };

    async function createPeerConnection(remoteUsername) {
      if (!iceServers) {
        socket.emit("request-ice");
        iceServers = await new Promise(resolve =>
          socket.once("ice-servers", resolve)
        );
      }

      const pc = new RTCPeerConnection({ iceServers });

      pc.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("webrtc-candidate", { from: username, to: remoteUsername, candidate: e.candidate });
        }
      };

      return pc;
    }

    /* === –ù–ê–ß–ê–¢–¨ –í–ò–î–ï–û (–∫–∞–∫ –∑–≤–æ–Ω—è—â–∏–π) === */
    startVideo.onclick = async () => {
      const to = userSelect.value;
      if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞.");

      try {
        inCall = true;

        // –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–≤—É–∫ –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –±—ã–ª)
        const snd = document.getElementById("joinSound");
        snd.pause();
        snd.currentTime = 0;

        // —É–≤–µ–¥–æ–º–ª—è–µ–º —Ç–æ–≥–æ, –∫–æ–º—É –∑–≤–æ–Ω—è—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–∏–≥—Ä–∞–ª—Å—è –∑–≤—É–∫
        socket.emit("audio-join", { from: username, to });

        // –∑–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        peerConnection = await createPeerConnection(to);

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // –∫–Ω–æ–ø–∫–∏
        videoEnabled = true;
        audioEnabled = true;
        toggleVideo.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É";
        toggleAudio.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit("webrtc-offer", { from: username, to, offer });
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–∏–¥–µ–æ:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É/–º–∏–∫—Ä–æ—Ñ–æ–Ω: " + (err.message || err));
      }
    };

    // –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ñ—Ñ–µ—Ä–∞ ‚Äî –æ—Ç–≤–µ—á–∞–µ–º (callee)
    socket.on('webrtc-offer', async (payload) => {
      // payload: { from, to, offer }
      try {
        if (payload.to !== username) return; // –Ω–µ –¥–ª—è –Ω–∞—Å

        inCall = true;

        // —Å–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
        if (!localStream) {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
        }

        peerConnection = await createPeerConnection(payload.from);

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("webrtc-answer", { from: username, to: payload.from, answer });

        // —Å–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
        videoEnabled = true;
        audioEnabled = true;
        toggleVideo.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É";
        toggleAudio.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";

        // –ø–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ—á–∞—Ç (–µ—Å–ª–∏ —Å–∫—Ä—ã—Ç)
        videoChat.style.display = "flex";
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –æ—Ñ—Ñ–µ—Ä–∞:", err);
      }
    });

    socket.on("webrtc-answer", async (payload) => {
      // payload: { from, to, answer }
      try {
        if (payload.to !== username) return;
        if (peerConnection) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.answer));
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ answer:", err);
      }
    });

    socket.on("webrtc-candidate", async (payload) => {
      // payload: { from, to, candidate }
      try {
        if (payload.to !== username) return;
        if (peerConnection) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:", err);
      }
    });

    /* === –ö–Ω–æ–ø–∫–∏ mute/unmute === */
    toggleVideo.onclick = () => {
      if (!localStream) return;
      videoEnabled = !videoEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = videoEnabled);
      toggleVideo.textContent = videoEnabled ? "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" : "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É";
    };

    toggleAudio.onclick = () => {
      if (!localStream) return;
      audioEnabled = !audioEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = audioEnabled);
      toggleAudio.textContent = audioEnabled ? "–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω" : "–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
    };

    /* === –û–¢–ö–õ–Æ–ß–ò–¢–¨ –í–ò–î–ï–û === */
    stopVideo.onclick = () => {
      inCall = false;

      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;

      videoEnabled = true;
      audioEnabled = true;
      toggleVideo.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É";
      toggleAudio.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
    };

    /* === –ü–†–û–ò–ì–†–´–í–ê–ù–ò–ï –ó–í–£–ö–ê –¢–û–õ–¨–ö–û –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –í –ó–í–û–ù–ö–ï === */
    socket.on("audio-join", ({ from }) => {
      // –∑–≤—É–∫ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –∑–≤–æ–Ω–∫–µ
      if (!inCall) {
        const snd = document.getElementById("joinSound");
        snd.volume = 1;
        snd.play().catch(() => {});
      }
    });

    /* === HELPERS === */
    if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/sw.js")
      .then(() => console.log("‚úÖ Service Worker registered"))
      .catch(err => console.error("‚ùå SW error", err));
  });
}
    // –ü—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–ø—Ä–æ—Å–∏–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω
    socket.emit("get-active");

    function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
  </script>
</body>
</html>







