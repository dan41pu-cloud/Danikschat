<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Danikschat</title>

  <style>
    body {
      font-family: sans-serif;
      background: #2f3136;
      color: white;
      margin: 0;
      padding: 20px;
    }

    #auth, #chat {
      background: #36393f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 420px;
      display: none;
      flex-direction: column;
      margin: 20px auto;
    }

    #auth.active, #chat.active { display: flex; }

    input, button {
      margin: 5px 0;
      padding: 10px;
      border-radius: 6px;
      border: none;
      width: 100%;
    }

    button { background: #5865f2; color: white; cursor: pointer; }
    button:hover { background: #4752c4; }

    ul { list-style: none; padding: 0; margin: 0; height: 250px; overflow-y: auto; }
    li { background: #40444b; padding: 10px; margin: 8px 0; border-radius: 10px; max-width: 70%; }
    .my-message { background: #7289da; margin-left: auto; }

    .message-username { font-weight: bold; }
    .message-time { font-size: 10px; color: #bbb; text-align: right; }

    #videoCall { margin-top: 20px; display: none; text-align: center; }
    video { width: 45%; border-radius: 10px; margin: 5px; }
  </style>
</head>
<body>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div id="auth" class="active">
    <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="login">–í–æ–π—Ç–∏</button>
    <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat">
    <h2 id="welcome"></h2>

    <ul id="messages"></ul>

    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <input type="file" id="imageInput" accept="image/*" />

    <div id="emojiPicker">
      <button class="emoji">üòÄ</button>
      <button class="emoji">üòÇ</button>
      <button class="emoji">üòç</button>
      <button class="emoji">üòé</button>
      <button class="emoji">üëç</button>
    </div>
  </div>


  <!-- –í–ò–î–ï–û–ó–í–û–ù–û–ö -->
  <div id="videoCall">
    <h3>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h3>
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <br>
    <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button id="hangupBtn">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
  </div>


  <script src="https://danikschat-dvtc.onrender.com/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const authDiv = document.getElementById("auth");
    const chatDiv = document.getElementById("chat");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const authMsg = document.getElementById("authMsg");
    const welcome = document.getElementById("welcome");
    const messages = document.getElementById("messages");
    const input = document.getElementById("input");
    const send = document.getElementById("send");
    const imageInput = document.getElementById("imageInput");
    const emojiButtons = document.querySelectorAll(".emoji");

    let username = null;
    let admin = false;

    // ===== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
    document.getElementById("register").onclick = () => {
      socket.emit("register", {
        username: usernameInput.value.trim(),
        password: passwordInput.value.trim()
      });
    };

    // ===== –í–•–û–î
    document.getElementById("login").onclick = () => {
      socket.emit("login", {
        username: usernameInput.value.trim(),
        password: passwordInput.value.trim()
      });
    };

    socket.on("registerSuccess", msg => authMsg.textContent = msg);
    socket.on("registerError", msg => authMsg.textContent = msg);
    socket.on("loginError", msg => authMsg.textContent = msg);

    socket.on("loginSuccess", (data) => {
      username = data.username;
      admin = data.admin;

      authDiv.classList.remove("active");
      chatDiv.classList.add("active");

      document.getElementById("videoCall").style.display = "block";

      welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

      data.messages.forEach(addMessage);
    });


    // ===== –û–¢–ü–†–ê–í–ö–ê –¢–ï–ö–°–¢–ê
    send.onclick = () => {
      const text = input.value.trim();
      if (text) {
        socket.emit("chat message", { username, text });
        input.value = "";
      }
    };

    function addMessage(msg) {
      const li = document.createElement("li");
      if (msg.username === username) li.classList.add("my-message");

      if (msg.text) {
        li.innerHTML =
          `<div class="message-username">${msg.username}</div>
           <div>${msg.text}</div>
           <div class="message-time">${msg.time}</div>`;
      } else if (msg.data) {
        li.innerHTML =
          `<div class="message-username">${msg.username}</div>
           <img src="${msg.data}" style="max-width:200px; border-radius:8px;">
           <div class="message-time">${msg.time}</div>`;
      }

      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on("chat message", addMessage);
    socket.on("chat image", addMessage);

    // ===== –≠–ú–û–î–ó–ò
    emojiButtons.forEach(btn => {
      btn.onclick = () => {
        socket.emit("chat message", { username, text: btn.textContent });
      };
    });

    // ===== –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
    imageInput.onchange = () => {
      const file = imageInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("chat image", { username, data: reader.result });
      };
      reader.readAsDataURL(file);
      imageInput.value = "";
    };


    // ========================================
    // ==========  WEBRTC ‚Äî –í–ò–î–ï–û  ============
    // ========================================

    let localVideo = document.getElementById("localVideo");
    let remoteVideo = document.getElementById("remoteVideo");
    let callBtn = document.getElementById("callBtn");
    let hangupBtn = document.getElementById("hangupBtn");

    let pc;
    let localStream;

    const rtcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    async function startLocalVideo() {
      localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
      localVideo.srcObject = localStream;
    }
    startLocalVideo();

    callBtn.onclick = async () => {
      pc = createPeerConnection();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      socket.emit("offer", offer);
    };

    hangupBtn.onclick = () => {
      if (pc) pc.close();
      pc = null;
    };

    function createPeerConnection() {
      const pc = new RTCPeerConnection(rtcConfig);

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", event.candidate);
        }
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      return pc;
    }

    socket.on("offer", async (offer) => {
      if (!pc) {
        pc = createPeerConnection();
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      }

      await pc.setRemoteDescription(offer);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      socket.emit("answer", answer);
    });

    socket.on("answer", async (answer) => {
      await pc.setRemoteDescription(answer);
    });

    socket.on("ice-candidate", async (candidate) => {
      if (pc) {
        await pc.addIceCandidate(candidate);
      }
    });
  </script>
</body>
</html>
