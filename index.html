<!-- Заготовка: HTML + JS + CSS + приватные чаты + контакты + приватные звонки -->
<!-- Очень большой проект: здесь только фронтенд файл index.html. В следующем сообщении я добавлю server.js -->

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messenger</title>
<style>
 body {
   font-family: sans-serif;
   background: #2f3136;
   color: white;
   margin: 0;
   padding: 0;
 }

 #auth, #messenger {
   max-width: 900px;
   margin: 20px auto;
   background: #36393f;
   padding: 20px;
   border-radius: 12px;
   display: none;
 }

 .active { display: block; }

 input, button {
   margin: 5px 0;
   padding: 10px;
   border: none;
   border-radius: 6px;
 }

 button {
   background: #5865f2;
   color: white;
   cursor: pointer;
 }
 button:hover { background: #4752c4; }

 /* Messenger layout */
 #messenger {
   display: flex;
   gap: 10px;
   height: 80vh;
 }

 #sidebar {
   width: 30%;
   background: #2f3136;
   border-radius: 12px;
   padding: 10px;
   overflow-y: auto;
 }

 #contacts li {
   padding: 10px;
   background: #40444b;
   margin: 5px 0;
   border-radius: 8px;
   cursor: pointer;
 }

 #contacts li:hover {
   background: #4f545c;
 }

 #chatArea {
   width: 70%;
   background: #36393f;
   border-radius: 12px;
   padding: 10px;
   display: flex;
   flex-direction: column;
 }

 #messages {
   flex-grow: 1;
   overflow-y: auto;
   list-style: none;
   padding: 0;
 }

 #messages li {
   background: #40444b;
   padding: 10px;
   border-radius: 10px;
   width: fit-content;
   max-width: 70%;
   margin: 6px 0;
 }

 .my-message { margin-left: auto; background: #7289da; }

 #messageInput { display: flex; gap: 5px; }

 #callUser {
   margin-top: 10px;
   background: #00aaff;
 }
</style>
</head>
<body>

<!-- Авторизация -->
<div id="auth" class="active">
  <h2>Вход / Регистрация</h2>
  <input id="username" placeholder="Имя" />
  <input id="password" type="password" placeholder="Пароль" />
  <button id="login">Войти</button>
  <button id="register">Регистрация</button>
  <p id="authMsg"></p>
</div>

<!-- Мессенджер -->
<div id="messenger">
  <div id="sidebar">
    <h3>Контакты</h3>
    <ul id="contacts"></ul>
  </div>

  <div id="chatArea">
    <h2 id="chatWith">Выберите контакт</h2>
    <ul id="messages"></ul>

    <div id="messageInput">
      <input id="input" placeholder="Сообщение...">
      <button id="send">Отправить</button>
    </div>

    <button id="callUser">Позвонить</button>
  </div>
</div>

<!-- Video Chat -->
<div id="videoChat" style="display:none; max-width:900px; margin:20px auto; background:#36393f; padding:20px; border-radius:12px;">
  <h3>Видеозвонок</h3>
  <video id="localVideo" autoplay muted playsinline style="width:45%; background:black;"></video>
  <video id="remoteVideo" autoplay playsinline style="width:45%; background:black; margin-left:5%;"></video>

  <br>
  <button id="endCall">Завершить</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let username = null;
let users = [];
let allMessages = {}; // { user: [ {from,text}, ... ] }
let currentChatUser = null;

const auth = document.getElementById("auth");
const messenger = document.getElementById("messenger");
const contacts = document.getElementById("contacts");
const messages = document.getElementById("messages");
const chatWith = document.getElementById("chatWith");

function saveLocal(from, to, text) {
  const other = from === username ? to : from;
  if (!allMessages[other]) allMessages[other] = [];
  allMessages[other].push({ from, text });
}

function addMessage(msg) {
  const li = document.createElement("li");
  if (msg.from === username) li.classList.add("my-message");
  li.textContent = msg.from + ": " + msg.text;
  messages.appendChild(li);
  messages.scrollTop = messages.scrollHeight;
}

function openChatWith(user) {
  currentChatUser = user;
  chatWith.textContent = "Чат с " + user;
  messages.innerHTML = "";
  (allMessages[user] || []).forEach(addMessage);
}

function renderContacts(list) {
  contacts.innerHTML = "";
  list.forEach(name => {
    if (name === username) return;
    const li = document.createElement("li");
    li.textContent = name;
    li.onclick = () => openChatWith(name);
    contacts.appendChild(li);
  });
}

// Регистрация
register.onclick = () => {
  socket.emit("register", {
    username: username.value.trim(),
    password: password.value.trim(),
  });
};

login.onclick = () => {
  socket.emit("login", {
    username: username.value.trim(),
    password: password.value.trim(),
  });
};

socket.on("registerSuccess", m => authMsg.textContent = m);
socket.on("registerError", m => authMsg.textContent = m);
socket.on("loginError", m => authMsg.textContent = m);

socket.on("loginSuccess", data => {
  username = data.username;
  users = data.users;

  auth.classList.remove("active");
  messenger.classList.add("active");

  renderContacts(users);
});

// Отправка сообщений
send.onclick = () => {
  if (!currentChatUser) return alert("Выберите контакт!");
  const text = input.value.trim();
  if (!text) return;

  socket.emit("privateMessage", {
    from: username,
    to: currentChatUser,
    text
  });

  saveLocal(username, currentChatUser, text);
  addMessage({ from: username, text });
  input.value = "";
};

socket.on("privateMessage", msg => {
  saveLocal(msg.from, username, msg.text);
  if (currentChatUser === msg.from)
    addMessage(msg);
});

/* =============================
    WebRTC: приватные звонки
============================= */

let localStream = null;
let peer = null;
let callTarget = null;

const videoChat = document.getElementById("videoChat");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

callUser.onclick = async () => {
  if (!currentChatUser) return alert("Выберите контакт!");
  callTarget = currentChatUser;
  await startCall();
};
\ async function startCall() {
  videoChat.style.display = "block";
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;

  peer = new RTCPeerConnection();
  localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

  peer.ontrack = e => remoteVideo.srcObject = e.streams[0];
  peer.onicecandidate = e => {
    if (e.candidate)
      socket.emit("call-candidate", { to: callTarget, candidate: e.candidate });
  };

  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);

  socket.emit("call-offer", {
    to: callTarget,
    from: username,
    offer
  });
}

socket.on("call-offer", async data => {
  callTarget = data.from;
  videoChat.style.display = "block";

  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;

  peer = new RTCPeerConnection();
  localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

  peer.ontrack = e => remoteVideo.srcObject = e.streams[0];
  peer.onicecandidate = e => {
    if (e.candidate)
      socket.emit("call-candidate", { to: callTarget, candidate: e.candidate });
  };

  await peer.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);

  socket.emit("call-answer", {
    to: data.from,
    from: username,
    answer
  });
});

socket.on("call-answer", async data => {
  await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
});

socket.on("call-candidate", async data => {
  if (peer)
    await peer.addIceCandidate(new RTCIceCandidate(data.candidate));
});

endCall.onclick = () => {
  videoChat.style.display = "none";
  if (peer) peer.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  peer = null;
};
</script>
</body>
</html>

