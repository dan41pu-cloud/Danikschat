# index.html

```html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чат + Видеозвонки</title>
  <style>
    body { font-family: Arial; background:#222; color:#fff; }
    #chat { max-width:600px; margin:20px auto; }
    #messages { background:#333; padding:10px; height:300px; overflow-y:auto; border-radius:10px; }
    #videoRoom video { background:#000; }
    button { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>

<div id="chat">
  <h2>Чат</h2>
  <div id="messages"></div>

  <input id="msg" placeholder="Введите сообщение" />
  <button id="send">Отправить</button>

  <br><br>
  <button id="videoCallBtn" style="background:#3ba55d;">Видеозвонок 1-на-1</button>

  <div id="videoRoom" style="display:none;margin-top:20px;">
    <h2 id="videoStatus">Ожидание второго пользователя...</h2>

    <video id="localVideo" autoplay playsinline muted style="width:100%;border-radius:10px;"></video>
    <video id="remoteVideo" autoplay playsinline style="width:100%;border-radius:10px;margin-top:10px;"></video>

    <button id="leaveVideo" style="background:#f04747;margin-top:10px;">Выйти</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();

// ------------------ ЧАТ ------------------
const messages = document.getElementById("messages");
const msg = document.getElementById("msg");
document.getElementById("send").onclick = () => {
  socket.emit("msg", msg.value);
  msg.value = "";
};

socket.on("msg", (text) => {
  const div = document.createElement("div");
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
});

// ------------------ Разрешения ------------------
async function requestPermissions() {
  try {
      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      stream.getTracks().forEach(t => t.stop());
      return true;
  } catch (err) {
      alert("Разрешите камеру и микрофон!");
      return false;
  }
}

// ------------------ ВИДЕОЧАТ ------------------
const videoBtn = document.getElementById("videoCallBtn");
const videoRoom = document.getElementById("videoRoom");
const videoStatus = document.getElementById("videoStatus");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const leaveVideo = document.getElementById("leaveVideo");

let localStream;
let peer;

videoBtn.onclick = async () => {
  const ok = await requestPermissions();
  if (!ok) return;

  videoRoom.style.display = "block";
  socket.emit("joinVideo");
};

leaveVideo.onclick = () => {
  socket.emit("leaveVideo");
  if (peer) peer.close();
  peer = null;
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  videoRoom.style.display = "none";
};

socket.on("videoReady", async () => {
  videoStatus.textContent = "Подключение...";

  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;

  peer = new RTCPeerConnection();
  localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

  peer.ontrack = e => remoteVideo.srcObject = e.streams[0];

  peer.onicecandidate = e => { if (e.candidate) socket.emit("ice", e.candidate); };

  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);
  socket.emit("offer", offer);
});

socket.on("offer", async (offer) => {
  videoStatus.textContent = "Подключение...";

  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;

  peer = new RTCPeerConnection();
  localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

  peer.ontrack = e => remoteVideo.srcObject = e.streams[0];

  peer.onicecandidate = e => { if (e.candidate) socket.emit("ice", e.candidate); };

  await peer.setRemoteDescription(offer);
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);
  socket.emit("answer", answer);
});

socket.on("answer", async (answer) => {
  await peer.setRemoteDescription(answer);
});

socket.on("ice", async candidate => {
  if (peer) await peer.addIceCandidate(candidate);
});

socket.on("videoLeft", () => {
  videoStatus.textContent = "Пользователь вышел. Ожидание...";
  remoteVideo.srcObject = null;
});

</script>
</body>
</html>
```

---

# server.js

```javascript
const express = require("express");
const app = express();
const http = require("http").createServer(app);
const io = require("socket.io")(http, { cors:{origin:"*"} });

app.use(express.static(__dirname));

let videoRoomUsers = [];

io.on("connection", socket => {

  // ----------- ЧАТ -----------
  socket.on("msg", text => {
    io.emit("msg", text);
  });

  // ----------- ВИДЕОЧАТ -----------
  socket.on("joinVideo", () => {
    videoRoomUsers.push(socket.id);

    if (videoRoomUsers.length === 2) {
      io.to(videoRoomUsers[0]).emit("videoReady");
      io.to(videoRoomUsers[1]).emit("videoReady");
    }
  });

  socket.on("leaveVideo", () => {
    videoRoomUsers = videoRoomUsers.filter(id => id !== socket.id);
    socket.broadcast.emit("videoLeft");
  });

  socket.on("offer", (offer) => {
    socket.broadcast.emit("offer", offer);
  });

  socket.on("answer", (answer) => {
    socket.broadcast.emit("answer", answer);
  });

  socket.on("ice", (candidate) => {
    socket.broadcast.emit("ice", candidate);
  });

  socket.on("disconnect", () => {
    videoRoomUsers = videoRoomUsers.filter(id => id !== socket.id);
    socket.broadcast.emit("videoLeft");
  });
});

http.listen(3000, () => console.log("Сервер работает на порту 3000"));
```
