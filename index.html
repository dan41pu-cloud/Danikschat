<!DOCTYPE html>
}


pmSend.onclick = () => {
socket.emit("pm", { to: currentChat, text: pmInput.value });
pmLog.innerHTML += `<div><b>Вы:</b> ${pmInput.value}</div>`;
pmInput.value = "";
};


socket.on("pm", ({ from, text }) => {
if (currentChat === from)
pmLog.innerHTML += `<div><b>${from}:</b> ${text}</div>`;
});


// CALL SYSTEM
socket.on("incoming-call", ({ from }) => {
if (!confirm(`Вам звонит ${from}. Ответить?`)) {
socket.emit("call-answer", { to: from, accepted: false });
return;
}
startCall(false, from);
socket.emit("call-answer", { to: from, accepted: true });
});


socket.on("call-answer", ({ from, accepted }) => {
if (!accepted) return alert("Пользователь отклонил звонок");
makeOffer(from);
});


async function startCall(isCaller, target){
callUI.style.display = "block";
localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
local.srcObject = localStream;


if (!iceServers){
socket.emit("get-ice");
iceServers = await new Promise(r => socket.once("ice", r));
}


pc = new RTCPeerConnection({ iceServers });
localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
pc.ontrack = e => remote.srcObject = e.streams[0];
pc.onicecandidate = e => {
if (e.candidate) socket.emit("webrtc-candidate", { to: target, candidate: e.candidate });
};
}


async function makeOffer(target){
const offer = await pc.createOffer();
await pc.setLocalDescription(offer);
socket.emit("webrtc-offer", { to: target, offer });
}


socket.on("webrtc-offer", async ({ from, offer }) => {
await startCall(false, from);
await pc.setRemoteDescription(new RTCSessionDescription(offer));
const answer = await pc.createAnswer();
await pc.setLocalDescription(answer);
socket.emit("webrtc-answer", { to: from, answer });
});


socket.on("webrtc-answer", async ({ answer }) => {
await pc.setRemoteDescription(new RTCSessionDescription(answer));
});


socket.on("webrtc-candidate", async ({ candidate }) => {
await pc.addIceCandidate(new RTCIceCandidate(candidate));
});


endCall.onclick = () => {
pc.close(); pc = null;
localStream.getTracks().forEach(t => t.stop());
callUI.style.display = "none";
};


</script>
</body>
</html>
