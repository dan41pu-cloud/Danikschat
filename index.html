<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Danikschat</title>
  <style>
    body {
      font-family: sans-serif;
      background: #2f3136;
      color: white;
      margin: 0;
      padding: 20px;
    }

    #auth, #chat {
      background: #36393f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 520px;
      display: none;
      flex-direction: column;
      margin: 20px auto;
    }

    #auth.active, #chat.active {
      display: flex;
    }

    input, button, select {
      margin: 5px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: #5865f2;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #4752c4;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
    }

    li {
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      background: #40444b;
      width: fit-content;
      max-width: 70%;
    }

    .my-message { background: #7289da; margin-left: auto; }
    .message-username { font-weight: bold; margin-bottom: 4px; }
    .message-time { font-size: 10px; text-align: right; color: gray; }

    #emojiPicker { margin-top: 10px; display: flex; gap: 6px; }
    #emojiPicker button { cursor: pointer; padding: 6px 10px; font-size: 18px; }

    #videoChat {
      margin-top: 20px;
      background:#36393f;
      padding: 15px;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      max-width: 520px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }

    #videoChat .controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .vc-btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #5865f2;
      color: white;
      min-width: 120px;
    }
    .vc-btn:hover { background: #4752c4; }

    .vc-btn.danger { background: #f04747; }
    .vc-btn.secondary { background: #4a4f55; }

    video { background: black; border-radius: 8px; }
    #localVideo { height: 240px; object-fit: cover; }
    #remoteVideo { height: 240px; object-fit: cover; margin-top: 10px; }
  </style>
</head>
<body>

  <audio id="joinSound" src="join.mp3"></audio>

  <div id="auth" class="active">
    <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="login">–í–æ–π—Ç–∏</button>
    <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg"></p>
  </div>

  <div id="chat">
    <h2 id="welcome"></h2>
    <label for="userSelect">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ (–æ–Ω–ª–∞–π–Ω):</label>
    <select id="userSelect">
      <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
    </select>

    <ul id="messages"></ul>
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <input type="file" id="imageInput" accept="image/*" />
    <div id="emojiPicker">
      <button class="emoji">üòÄ</button>
      <button class="emoji">üòÇ</button>
      <button class="emoji">üòç</button>
      <button class="emoji">üòé</button>
      <button class="emoji">üëç</button>
    </div>

    <button id="openVideoChat">–í–∏–¥–µ–æ—á–∞—Ç</button>
  </div>

  <div id="videoChat">
    <h3>–í–∏–¥–µ–æ—á–∞—Ç</h3>
    <video id="localVideo" autoplay playsinline muted style="width:100%; border-radius:10px;"></video>
    <video id="remoteVideo" autoplay playsinline style="width:100%; margin-top:10px; border-radius:10px;"></video>

    <div class="controls">
      <button id="startVideo" class="vc-btn">–ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
      <button id="stopVideo" class="vc-btn danger">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
      <button id="toggleVideo" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
      <button id="toggleAudio" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let allUsers = [];
    let onlineUsers = [];

    const socket = io();

    // === –≠–õ–ï–ú–ï–ù–¢–´ DOM ===
    const authDiv = document.getElementById('auth');
    const chatDiv = document.getElementById('chat');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const authMsg = document.getElementById('authMsg');
    const welcome = document.getElementById('welcome');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const imageInput = document.getElementById("imageInput");
    const emojiButtons = document.querySelectorAll(".emoji");
    const userSelect = document.getElementById("userSelect");

    let username = null;
    let admin = false;
    let inCall = false;
    let localStream = null;
    let peerConnection = null;
    let iceServers = null;
    let videoEnabled = true;
    let audioEnabled = true;

    // === –ü–†–û–í–ï–†–ö–ê LOCALSTORAGE ===
    window.addEventListener('load', () => {
      const savedUsername = localStorage.getItem('username');
      if (savedUsername) {
        socket.emit('loginFromStorage', { username: savedUsername });
      }
    });

    // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –í–•–û–î ===
    document.getElementById('register').onclick = () => {
      socket.emit('register', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };

    document.getElementById('login').onclick = () => {
      socket.emit('login', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };

    // === LOGIN SUCCESS ===
    socket.on('loginSuccess', (data) => {
      username = data.username;
      admin = data.admin;

      localStorage.setItem('username', username);
      localStorage.setItem('admin', admin);

      authDiv.classList.remove('active');
      chatDiv.classList.add('active');
      welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

      allUsers = data.users.filter(u => u !== username);
      onlineUsers = data.online;
      renderUsers();
      data.messages.forEach(addMessage);
    });

    // === LOGIN FROM LOCALSTORAGE SUCCESS ===
    socket.on('loginFromStorageSuccess', (data) => {
      username = data.username;
      admin = data.admin;

      authDiv.classList.remove('active');
      chatDiv.classList.add('active');
      welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

      allUsers = data.users.filter(u => u !== username);
      onlineUsers = data.online;
      renderUsers();
      data.messages.forEach(addMessage);
    });

    socket.on('registerSuccess', msg => authMsg.textContent = msg);
    socket.on('registerError', msg => authMsg.textContent = msg);
    socket.on('loginError', msg => {
      authMsg.textContent = msg;
      localStorage.removeItem('username');
      localStorage.removeItem('admin');
    });

    function logout() {
      localStorage.removeItem('username');
      localStorage.removeItem('admin');
      username = null;
      admin = false;
      authDiv.classList.add('active');
      chatDiv.classList.remove('active');
    }

    // === –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —á–∞—Ç–∞ ===
    function renderUsers() {
      const prev = userSelect.value;
      userSelect.innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>';
      allUsers.forEach(user => {
        const option = document.createElement("option");
        option.value = user;
        const online = onlineUsers.includes(user);
        option.textContent = online ? `${user} üü¢ –æ–Ω–ª–∞–π–Ω` : `${user} ‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω`;
        userSelect.appendChild(option);
      });
      if (prev && [...userSelect.options].some(o => o.value === prev)) {
        userSelect.value = prev;
      }
    }

    send.onclick = () => {
      const text = input.value.trim();
      const to = userSelect.value;
      if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ.");
      if (text) {
        socket.emit('chat message', { from: username, to, text });
        input.value = '';
      }
    };

    function addMessage(msg) {
      if (!(msg.from === username || msg.to === username)) return;
      const li = document.createElement('li');
      if (msg.from === username) li.classList.add('my-message');
      const peer = msg.from === username ? msg.to : msg.from;
      const title = `${peer} (${msg.from === username ? '—è ‚Üí ' + msg.to : msg.from})`;

      if (msg.type === 'text') {
        li.innerHTML = `<div class="message-username">${title}</div><div>${escapeHtml(msg.text)}</div><div class="message-time">${msg.time}</div>`;
      } else if (msg.type === 'image') {
        li.innerHTML = `<div class="message-username">${title}</div><img src="${msg.data}" style="max-width:200px; border-radius:8px; margin-top:4px;"><div class="message-time">${msg.time}</div>`;
      }
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on('private-message', addMessage);
    socket.on('chat-cleared', () => messages.innerHTML = '');

    emojiButtons.forEach(btn => {
      btn.onclick = () => {
        const to = userSelect.value;
        if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ.");
        socket.emit("chat message", { from: username, to, text: btn.textContent });
      };
    });

    imageInput.onchange = () => {
      const file = imageInput.files[0];
      if (!file) return;
      const to = userSelect.value;
      if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ.");
      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("chat image", { from: username, to, data: reader.result });
      };
      reader.readAsDataURL(file);
      imageInput.value = "";
    };

    // === –í–∏–¥–µ–æ—á–∞—Ç –∏ WebRTC ===
    const videoChat = document.getElementById("videoChat");
    const openVideoChat = document.getElementById("openVideoChat");
    const startVideo = document.getElementById("startVideo");
    const stopVideo = document.getElementById("stopVideo");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const toggleVideo = document.getElementById("toggleVideo");
    const toggleAudio = document.getElementById("toggleAudio");

    openVideoChat.onclick = () => { videoChat.style.display = "flex"; };

    async function createPeerConnection(remoteUsername) {
      if (!iceServers) {
        socket.emit("request-ice");
        iceServers = await new Promise(resolve => socket.once("ice-servers", resolve));
      }
      const pc = new RTCPeerConnection({ iceServers });
      pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };
      pc.onicecandidate = e => {
        if (e.candidate) socket.emit("webrtc-candidate", { from: username, to: remoteUsername, candidate: e.candidate });
      };
      return pc;
    }

    startVideo.onclick = async () => {
      const to = userSelect.value;
      if (!to) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞.");
      try {
        inCall = true;
        const snd = document.getElementById("joinSound"); snd.pause(); snd.currentTime = 0;
        socket.emit("audio-join", { from: username, to });

        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        peerConnection = await createPeerConnection(to);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        videoEnabled = true; audioEnabled = true;
        toggleVideo.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É";
        toggleAudio.textContent = "–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit("webrtc-offer", { from: username, to, offer });
      } catch (err) { console.error(err); alert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É/–º–∏–∫—Ä–æ—Ñ–æ–Ω."); }
    };

    socket.on('webrtc-offer', async (payload) => {
      if (payload.to !== username) return;
      try {
        inCall = true;
        if (!localStream) { localStream = await navigator.mediaDevices.getUserMedia({ video:true,audio:true }); localVideo.srcObject=localStream; }
        peerConnection = await createPeerConnection(payload.from);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("webrtc-answer",{from:username,to:payload.from,answer});
        videoEnabled=true; audioEnabled=true;
        toggleVideo.textContent="–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"; toggleAudio.textContent="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
        videoChat.style.display="flex";
      } catch(err){ console.error(err); }
    });

    socket.on("webrtc-answer", async payload => { if(payload.to===username && peerConnection) await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.answer)); });
    socket.on("webrtc-candidate", async payload => { if(payload.to===username && peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate)); });

    toggleVideo.onclick = () => { if(!localStream) return; videoEnabled=!videoEnabled; localStream.getVideoTracks().forEach(t=>t.enabled=videoEnabled); toggleVideo.textContent=videoEnabled?"–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É":"–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"; };
    toggleAudio.onclick = () => { if(!localStream) return; audioEnabled=!audioEnabled; localStream.getAudioTracks().forEach(t=>t.enabled=audioEnabled); toggleAudio.textContent=audioEnabled?"–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω":"–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω"; };
    stopVideo.onclick = () => { inCall=false; if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; } if(peerConnection){ peerConnection.close(); peerConnection=null; } remoteVideo.srcObject=null; videoEnabled=true; audioEnabled=true; toggleVideo.textContent="–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"; toggleAudio.textContent="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω"; };

    socket.on("audio-join",({from})=>{ if(!inCall){ const snd=document.getElementById("joinSound"); snd.volume=1; snd.play().catch(()=>{}); } });

    function escapeHtml(unsafe){ return unsafe.replace(/[&<"']/g,m=>({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m])); }

    socket.emit("get-active");
  </script>
</body>
</html>
