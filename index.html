<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danikschat</title>

  <style>
    body {
      font-family: sans-serif;
      background: #2f3136;
      color: white;
      margin: 0;
      padding: 20px;
    }

    #auth, #chat {
      background: #36393f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 520px;
      display: none;
      flex-direction: column;
      margin: 20px auto;
    }

    #auth.active, #chat.active {
      display: flex;
    }

    input, button, select {
      margin: 5px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: #5865f2;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #4752c4;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
    }

    li {
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      background: #40444b;
      width: fit-content;
      max-width: 70%;
    }

    .my-message {
      background: #7289da;
      margin-left: auto;
    }

    .message-username {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 10px;
      text-align: right;
      color: gray;
    }

    #emojiPicker {
      margin-top: 10px;
      display: flex;
      gap: 6px;
    }

    #emojiPicker button {
      font-size: 18px;
      cursor: pointer;
    }

    #videoChat {
      margin-top: 20px;
      background: #36393f;
      padding: 15px;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      max-width: 520px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .vc-btn {
      padding: 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #5865f2;
      color: white;
      min-width: 120px;
    }

    .vc-btn.danger { background: #f04747; }
    .vc-btn.secondary { background: #4a4f55; }

    video {
      width: 100%;
      height: 240px;
      background: black;
      border-radius: 10px;
      object-fit: cover;
    }
  </style>
</head>
<body>

<audio id="joinSound" src="join.mp3" muted></audio>

<div id="auth" class="active">
  <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="login">–í–æ–π—Ç–∏</button>
  <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <p id="authMsg"></p>
</div>

<div id="chat">
  <h2 id="welcome"></h2>

  <label>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫:</label>
  <select id="userSelect">
    <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
  </select>

  <ul id="messages"></ul>

  <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
  <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <input type="file" id="imageInput" accept="image/*">

  <div id="emojiPicker">
    <button class="emoji">üòÄ</button>
    <button class="emoji">üòÇ</button>
    <button class="emoji">üòç</button>
    <button class="emoji">üòé</button>
    <button class="emoji">üëç</button>
  </div>

  <button id="openVideoChat">–í–∏–¥–µ–æ—á–∞—Ç</button>
</div>

<div id="videoChat">
  <h3>–í–∏–¥–µ–æ—á–∞—Ç</h3>

  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div class="controls">
    <button id="startVideo" class="vc-btn">–ù–∞—á–∞—Ç—å</button>
    <button id="stopVideo" class="vc-btn danger">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
    <button id="toggleVideo" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
    <button id="toggleAudio" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const authDiv = document.getElementById("auth");
const chatDiv = document.getElementById("chat");
const userSelect = document.getElementById("userSelect");
const messages = document.getElementById("messages");
const input = document.getElementById("input");

let username = null;
let allUsers = [];
let onlineUsers = [];
let localStream = null;
let peerConnection = null;
let inCall = false;
let videoEnabled = true;
let audioEnabled = true;
let iceServers = null;

function renderUsers() {
  const prev = userSelect.value;
  userSelect.innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>';

  allUsers.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u;
    opt.textContent = onlineUsers.includes(u)
      ? `${u} üü¢ –æ–Ω–ª–∞–π–Ω`
      : `${u} ‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω`;
    userSelect.appendChild(opt);
  });

  if ([...userSelect.options].some(o => o.value === prev)) {
    userSelect.value = prev;
  }
}

function escapeHtml(text = "") {
  return String(text).replace(/[&<"']/g, m =>
    ({ "&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#039;" })[m]
  );
}

function addMessage(msg) {
  if (!(msg.from === username || msg.to === username)) return;

  const li = document.createElement("li");
  if (msg.from === username) li.classList.add("my-message");

  const title =
    msg.from === username
      ? `–í—ã ‚Üí ${msg.to}`
      : `${msg.from} ‚Üí –í—ã`;

  if (msg.type === "image") {
    li.innerHTML = `
      <div class="message-username">${title}</div>
      <img src="${msg.data}" style="max-width:200px;border-radius:8px">
      <div class="message-time">${msg.time}</div>`;
  } else {
    li.innerHTML = `
      <div class="message-username">${title}</div>
      <div>${escapeHtml(msg.text)}</div>
      <div class="message-time">${msg.time}</div>`;
  }

  messages.appendChild(li);
  messages.scrollTop = messages.scrollHeight;
}

/* === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø === */

document.getElementById("register").onclick = () => {
  socket.emit("register", {
    username: usernameInput.value.trim(),
    password: passwordInput.value.trim()
  });
};

document.getElementById("login").onclick = () => {
  socket.emit("login", {
    username: usernameInput.value.trim(),
    password: passwordInput.value.trim()
  });
};

socket.on("loginSuccess", data => {
  username = data.username;
  authDiv.classList.remove("active");
  chatDiv.classList.add("active");
  welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

  allUsers = data.users.filter(u => u !== username);
  onlineUsers = data.online;

  renderUsers();
  data.messages.forEach(addMessage);
});

socket.on("active-users", list => {
  onlineUsers = list;
  renderUsers();
});

document.getElementById("send").onclick = () => {
  const to = userSelect.value;
  if (!to || !input.value.trim()) return;
  socket.emit("chat message", {
    from: username,
    to,
    text: input.value.trim()
  });
  input.value = "";
};

socket.on("private-message", addMessage);

/* === –ó–í–£–ö –í–•–û–î–Ø–©–ï–ì–û –ó–í–û–ù–ö–ê === */
socket.on("audio-join", () => {
  if (!inCall) {
    const snd = document.getElementById("joinSound");
    snd.muted = false;
    snd.play().catch(() => {});
  }
});
</script>
</body>
</html>
