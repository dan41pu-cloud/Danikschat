<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Danikschat (–ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —á–∞—Ç—ã)</title>
  <style>
    body {
      font-family: sans-serif;
      background: #2f3136;
      color: white;
      margin: 0;
      padding: 20px;
    }

    #auth, #chat {
      background: #36393f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 520px;
      display: none;
      flex-direction: column;
      margin: 20px auto;
    }

    #auth.active, #chat.active {
      display: flex;
    }

    input, button, select {
      margin: 5px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: #5865f2;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #4752c4;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
    }

    li {
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      background: #40444b;
      width: fit-content;
      max-width: 70%;
    }

    .my-message { background: #7289da; margin-left: auto; }
    .message-username { font-weight: bold; margin-bottom: 4px; }
    .message-time { font-size: 10px; text-align: right; color: gray; }

    #emojiPicker { margin-top: 10px; display: flex; gap: 6px; }
    #emojiPicker button { cursor: pointer; padding: 6px 10px; font-size: 18px; }

    #videoChat {
      margin-top: 20px;
      background:#36393f;
      padding: 15px;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      max-width: 520px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }

    #videoChat .controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .vc-btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #5865f2;
      color: white;
      min-width: 120px;
    }
    .vc-btn:hover { background: #4752c4; }

    .vc-btn.danger { background: #f04747; }
    .vc-btn.secondary { background: #4a4f55; }

    video { background: black; border-radius: 8px; }
    #localVideo { height: 240px; object-fit: cover; }
    #remoteVideo { height: 240px; object-fit: cover; margin-top: 10px; }
  </style>
</head>
<body>

<audio id="joinSound" src="join.mp3"></audio>

<div id="auth" class="active">
  <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
  <button id="login">–í–æ–π—Ç–∏</button>
  <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <p id="authMsg"></p>
</div>

<div id="chat">
  <h2 id="welcome"></h2>

  <label>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ (–í–°–ï –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ):</label>
  <select id="userSelect">
    <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
  </select>

  <!-- üî• –î–û–ë–ê–í–õ–ï–ù–û -->
  <label style="margin-top:10px;">
    <input type="checkbox" id="selectAllUsers">
    –ù–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
  </label>

  <ul id="messages"></ul>

  <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
  <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <input type="file" id="imageInput" accept="image/*" />

  <div id="emojiPicker">
    <button class="emoji">üòÄ</button>
    <button class="emoji">üòÇ</button>
    <button class="emoji">üòç</button>
    <button class="emoji">üòé</button>
    <button class="emoji">üëç</button>
  </div>

  <button id="openVideoChat">–í–∏–¥–µ–æ—á–∞—Ç</button>
</div>

<div id="videoChat">
  <h3>–í–∏–¥–µ–æ—á–∞—Ç (–ø—Ä–∏–≤–∞—Ç–Ω–æ)</h3>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div class="controls">
    <button id="startVideo" class="vc-btn">–ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
    <button id="stopVideo" class="vc-btn danger">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
    <button id="toggleVideo" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
    <button id="toggleAudio" class="vc-btn secondary">–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let username = null;
let allUsers = [];

const authDiv = document.getElementById('auth');
const chatDiv = document.getElementById('chat');
const userSelect = document.getElementById("userSelect");
const selectAllUsers = document.getElementById("selectAllUsers");
const input = document.getElementById("input");
const messages = document.getElementById("messages");

login.onclick = () => {
  socket.emit('login', {
    username: usernameInput.value.trim(),
    password: passwordInput.value.trim()
  });
};

register.onclick = () => {
  socket.emit('register', {
    username: usernameInput.value.trim(),
    password: passwordInput.value.trim()
  });
};

socket.on('loginSuccess', data => {
  username = data.username;
  authDiv.classList.remove('active');
  chatDiv.classList.add('active');
  welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;

  data.messages.forEach(addMessage);

  socket.emit("get-all-users");
});

socket.on("all-users", list => {
  allUsers = list.filter(u => u !== username);
  userSelect.innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>';
  allUsers.forEach(u => {
    const o = document.createElement("option");
    o.value = u;
    o.textContent = u;
    userSelect.appendChild(o);
  });
});

send.onclick = () => {
  const text = input.value.trim();
  if (!text) return;

  const targets = selectAllUsers.checked
    ? allUsers
    : [userSelect.value];

  if (!targets[0]) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è");

  targets.forEach(to => {
    socket.emit("chat-private", { from: username, to, text });
  });

  input.value = "";
};

socket.on("private-message", addMessage);

function addMessage(msg) {
  if (msg.from !== username && msg.to !== username) return;
  const li = document.createElement("li");
  if (msg.from === username) li.classList.add("my-message");
  li.innerHTML = `<b>${msg.from}</b>: ${msg.text}`;
  messages.appendChild(li);
}
</script>
</body>
</html>
