<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Danikschat</title>
  <style>
    body {
      font-family: sans-serif;
      background: #2f3136;
      color: white;
      margin: 0;
      padding: 20px;
    }

    #auth, #chat {
      background: #36393f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 420px;
      display: none;
      flex-direction: column;
      margin: 20px auto;
    }

    #auth.active, #chat.active {
      display: flex;
    }

    input, button {
      margin: 5px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      width: 100%;
    }

    button {
      background: #5865f2;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #4752c4;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
    }

    li {
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      background: #40444b;
      width: fit-content;
      max-width: 70%;
    }

    .my-message { background: #7289da; margin-left: auto; }
    .message-username { font-weight: bold; margin-bottom: 4px; }
    .message-time { font-size: 10px; text-align: right; color: gray; }

    #emojiPicker { margin-top: 10px; display: flex; gap: 6px; }
    #emojiPicker button { cursor: pointer; padding: 6px 10px; font-size: 18px; }
  </style>
</head>
<body>

  <!-- üîä –ê–£–î–ò–û –î–õ–Ø –ó–í–£–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø -->
  <audio id="joinSound" src="join.mp3"></audio>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div id="auth" class="active">
    <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="login">–í–æ–π—Ç–∏</button>
    <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat">
    <h2 id="welcome"></h2>
    <ul id="messages"></ul>
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <input type="file" id="imageInput" accept="image/*" />
    <div id="emojiPicker">
      <button class="emoji">üòÄ</button>
      <button class="emoji">üòÇ</button>
      <button class="emoji">üòç</button>
      <button class="emoji">üòé</button>
      <button class="emoji">üëç</button>
    </div>

    <!-- –∫–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –≤–∏–¥–µ–æ -->
    <button id="openVideoChat">–í–∏–¥–µ–æ—á–∞—Ç</button>
  </div>

  <!-- –í–ò–î–ï–û–ß–ê–¢ -->
  <div id="videoChat" style="
    margin-top: 20px;
    background:#36393f;
    padding: 15px;
    border-radius: 12px;
    display: none;
    flex-direction: column;
    max-width: 420px;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
  ">
    <h3>–í–∏–¥–µ–æ—á–∞—Ç</h3>

    <video id="localVideo" autoplay playsinline muted style="width:100%; border-radius:10px; background:black;"></video>
    <video id="remoteVideo" autoplay playsinline style="width:100%; margin-top:10px; border-radius:10px; background:black;"></video>

    <button id="startVideo">–ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
    <button id="stopVideo" style="background:#f04747;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
  </div>

  <script src="https://danikschat-dvtc.onrender.com/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    /* === –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞ === */
    let inCall = false;

    const authDiv = document.getElementById('auth');
    const chatDiv = document.getElementById('chat');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const authMsg = document.getElementById('authMsg');
    const welcome = document.getElementById('welcome');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const imageInput = document.getElementById("imageInput");
    const emojiButtons = document.querySelectorAll(".emoji");

    let username = null;
    let admin = false;

    document.getElementById('register').onclick = () => {
      socket.emit('register', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };

    document.getElementById('login').onclick = () => {
      socket.emit('login', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };

    socket.on('registerSuccess', msg => authMsg.textContent = msg);
    socket.on('registerError', msg => authMsg.textContent = msg);
    socket.on('loginError', msg => authMsg.textContent = msg);

    socket.on('loginSuccess', (data) => {
      username = data.username;
      admin = data.admin;

      authDiv.classList.remove('active');
      chatDiv.classList.add('active');
      welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;
      data.messages.forEach(addMessage);
    });

    send.onclick = () => {
      const text = input.value.trim();
      if (text) {
        socket.emit('chat message', { username, text });
        input.value = '';
      }
    };

    function addMessage(msg) {
      const li = document.createElement('li');
      if (msg.username === username) li.classList.add('my-message');

      if (msg.text) {
        li.innerHTML = `<div class="message-username">${msg.username}</div><div>${msg.text}</div><div class="message-time">${msg.time}</div>`;
      } else if (msg.data) {
        li.innerHTML = `<div class="message-username">${msg.username}</div><img src="${msg.data}" style="max-width:200px; border-radius:8px; margin-top:4px;"><div class="message-time">${msg.time}</div>`;
      }

      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on('chat message', addMessage);
    socket.on('chat image', addMessage);

    emojiButtons.forEach(btn => {
      btn.onclick = () => {
        socket.emit("chat message", { username, text: btn.textContent });
      };
    });

    imageInput.onchange = () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("chat image", { username, data: reader.result });
      };
      reader.readAsDataURL(file);
      imageInput.value = "";
    };

    /* === –í–ò–î–ï–û–ß–ê–¢ === */

    const videoChat = document.getElementById("videoChat");
    const openVideoChat = document.getElementById("openVideoChat");
    const startVideo = document.getElementById("startVideo");
    const stopVideo = document.getElementById("stopVideo");

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    let localStream;
    let peerConnection;

    openVideoChat.onclick = () => {
      videoChat.style.display = "flex";
    };

    /* === –ù–ê–ß–ê–¢–¨ –í–ò–î–ï–û === */
    startVideo.onclick = async () => {

      inCall = true; // —Ç–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∑–≤–æ–Ω–∫–µ

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É–∑—ã–∫—É —É —Å–µ–±—è
      const snd = document.getElementById("joinSound");
      snd.pause();
      snd.currentTime = 0;

      // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É: –∫—Ç–æ-—Ç–æ –≤–æ—à—ë–ª –≤ –∑–≤–æ–Ω–æ–∫
      socket.emit("audio-join", username);

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å!
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      peerConnection = new RTCPeerConnection();
      // Node Get ICE STUN and TURN list
let o = {
      format: "urls"
};

let bodyString = JSON.stringify(o);
let https = require("https://danikschat-1-xabj.onrender.com");
let options = {
      host: "global.xirsys.net",
      path: "/_turn/MyFirstApp",
      method: "PUT",
      headers: {
          "Authorization": "Basic " + Buffer.from("daniil:787333b8-cedf-11f0-bad6-0242ac130003").toString("base64"),
          "Content-Type": "application/json",
          "Content-Length": bodyString.length
      }
};
let httpreq = https.request(options, function(httpres) {
      let str = "";
      httpres.on("data", function(data){ str += data; });
      httpres.on("error", function(e){ console.log("error: ",e); });
      httpres.on("end", function(){ 
          console.log("ICE List: ", str);
      });
});
httpreq.on("error", function(e){ console.log("request error: ",e); });
httpreq.end();

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate) socket.emit("webrtc-candidate", e.candidate);
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit("webrtc-offer", offer);
    };

    socket.on("webrtc-offer", async offer => {

      inCall = true;

      peerConnection = new RTCPeerConnection();

      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate) socket.emit("webrtc-candidate", e.candidate);
      };

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit("webrtc-answer", answer);
    });

    socket.on("webrtc-answer", async answer => {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on("webrtc-candidate", async candidate => {
      if (peerConnection) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      }
    });

    /* === –û–¢–ö–õ–Æ–ß–ò–¢–¨ –í–ò–î–ï–û === */
    stopVideo.onclick = () => {
      inCall = false;

      if (localStream) localStream.getTracks().forEach(track => track.stop());
      if (peerConnection) peerConnection.close();
      remoteVideo.srcObject = null;
    };

    /* === –ü–†–û–ò–ì–†–´–í–ê–ù–ò–ï –ó–í–£–ö–ê –¢–û–õ–¨–ö–û –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –í –ó–í–û–ù–ö–ï === */
    socket.on("audio-join", (name) => {
      if (!inCall) {
        const snd = document.getElementById("joinSound");
        snd.volume = 1;
        snd.play().catch(() => {});
      }
    });

  </script>
</body>
</html>


