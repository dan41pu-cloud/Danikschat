<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Danikschat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  background: #2f3136;
  color: white;
  padding: 20px;
}
#auth, #chat {
  background: #36393f;
  padding: 20px;
  border-radius: 12px;
  max-width: 500px;
  margin: auto;
}
#chat { display: none; }
input, button, select {
  width: 100%;
  margin: 5px 0;
  padding: 10px;
  border-radius: 6px;
  border: none;
}
button { background:#5865f2; color:white; cursor:pointer; }
ul { list-style:none; padding:0; max-height:300px; overflow-y:auto; }
li {
  background:#40444b;
  margin:6px 0;
  padding:10px;
  border-radius:8px;
}
.my { background:#7289da; text-align:right; }
</style>
</head>

<body>

<div id="auth">
  <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <input id="username" placeholder="–ò–º—è">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="login">–í–æ–π—Ç–∏</button>
  <button id="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <p id="authMsg"></p>
</div>

<div id="chat">
  <h3 id="welcome"></h3>

  <select id="userSelect"></select>

  <label>
    <input type="checkbox" id="selectAll">
    –ù–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ–º
  </label>

  <ul id="messages"></ul>

  <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
  <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const auth = document.getElementById("auth");
const chat = document.getElementById("chat");
const msgBox = document.getElementById("messages");

let username = "";
let allUsers = [];

login.onclick = () => {
  socket.emit("login", {
    username: username.value,
    password: password.value
  });
};

register.onclick = () => {
  socket.emit("register", {
    username: username.value,
    password: password.value
  });
};

socket.on("loginSuccess", data => {
  username = data.username;
  auth.style.display = "none";
  chat.style.display = "block";
  welcome.textContent = "–ü—Ä–∏–≤–µ—Ç, " + username;

  data.messages.forEach(addMessage);

  if (data.missedCalls.length) {
    data.missedCalls.forEach(c =>
      alert(`üìû –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${c.from}`)
    );
  }

  socket.emit("get-all-users");
});

socket.on("all-users", list => {
  allUsers = list.filter(u => u !== username);
  userSelect.innerHTML = "<option value=''>-- –≤—ã–±—Ä–∞—Ç—å --</option>";
  allUsers.forEach(u => {
    const o = document.createElement("option");
    o.value = u;
    o.textContent = u;
    userSelect.appendChild(o);
  });
});

send.onclick = () => {
  const text = document.getElementById("text").value.trim();
  if (!text) return;

  const targets = selectAll.checked
    ? allUsers
    : [userSelect.value];

  if (!targets[0]) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è");

  targets.forEach(to => {
    socket.emit("chat-private", { from: username, to, text });
    addMessage({ from: username, to, text, time: "—Å–µ–π—á–∞—Å" });
  });

  document.getElementById("text").value = "";
};

socket.on("private-message", addMessage);

function addMessage(msg) {
  if (msg.from !== username && msg.to !== username) return;

  const li = document.createElement("li");
  if (msg.from === username) li.className = "my";
  li.textContent = `${msg.from}: ${msg.text} (${msg.time})`;
  msgBox.appendChild(li);
  msgBox.scrollTop = msgBox.scrollHeight;
}
</script>
</body>
</html>
