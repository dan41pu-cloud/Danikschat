<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í–∏–¥–µ–æ —á–∞—Ç</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #f2f2f2;
    }
    #chat, #videoCall {
      margin-top: 20px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 5px #ccc;
    }
    video {
      width: 48%;
      background: #000;
      border-radius: 10px;
    }
  </style>
</head>

<body>

  <h2>–í–∏–¥–µ–æ —á–∞—Ç</h2>

  <!-- –õ–û–ì–ò–ù -->
  <div id="loginBox">
    <input type="text" id="loginInput" placeholder="–í–∞—à–µ –∏–º—è..." />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
  </div>

  <!-- –ß–ê–¢ -->
  <div id="chat" style="display:none;">
    <h3>–ß–∞—Ç</h3>
    <div id="messages" style="height:150px; overflow-y:auto; border:1px solid #aaa; padding:5px;"></div>
    <input type="text" id="msgInput" />
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –í–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫ -->
  <div id="videoCall" style="display:none;">
    <h3>–í–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫</h3>
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <br><br>

    <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button id="hangupBtn">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
  </div>

  <script>
    const socket = io();

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const loginBox = document.getElementById("loginBox");
    const loginBtn = document.getElementById("loginBtn");
    const loginInput = document.getElementById("loginInput");

    const chat = document.getElementById("chat");
    const messages = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const callBtn = document.getElementById("callBtn");
    const hangupBtn = document.getElementById("hangupBtn");

    let username = null;

    // ---------- –õ–û–ì–ò–ù ----------
    loginBtn.onclick = () => {
      username = loginInput.value.trim();
      if (!username) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

      socket.emit("join", username);

      loginBox.style.display = "none";
      chat.style.display = "block";
      document.getElementById("videoCall").style.display = "block";
    };

    // ---------- –ß–ê–¢ ----------
    sendBtn.onclick = () => {
      const text = msgInput.value;
      if (!text) return;

      socket.emit("chat-message", text);
      msgInput.value = "";
    };

    socket.on("chat-message", (data) => {
      let div = document.createElement("div");
      div.textContent = data.user + ": " + data.text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    });

    // ---------- WebRTC ----------
    let pc;
    let localStream;

    const rtcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    // –í–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã ‚Äî –∏–º–µ–Ω–Ω–æ –æ—Ç—Å—é–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ!
    async function startLocalVideo() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });

        // iPhone —Ç—Ä–µ–±—É–µ—Ç playsinline
        localVideo.setAttribute("playsinline", true);
        remoteVideo.setAttribute("playsinline", true);

        localVideo.srcObject = localStream;
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + err.message);
      }
    }

    function createPeerConnection() {
      const pc = new RTCPeerConnection(rtcConfig);

      pc.onicecandidate = (event) => {
        if (event.candidate)
          socket.emit("ice-candidate", event.candidate);
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      return pc;
    }

    // –ö–Ω–æ–ø–∫–∞ ‚Äî –ø–æ–∑–≤–æ–Ω–∏—Ç—å
    callBtn.onclick = async () => {
      await startLocalVideo();    // ‚Üê –¢–ï–ü–ï–†–¨ –ú–û–ë–ò–õ–´ –í–°–ï–ì–î–ê –ü–û–ö–ê–ñ–£–¢ –†–ê–ó–†–ï–®–ï–ù–ò–Ø

      pc = createPeerConnection();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      socket.emit("offer", offer);
    };

    // –ó–∞–≤–µ—Ä—à–∏—Ç—å
    hangupBtn.onclick = () => {
      if (pc) pc.close();
      pc = null;
    };

    // –°–∏–≥–Ω–∞–ª—ã WebRTC
    socket.on("offer", async (offer) => {
      await startLocalVideo();  // –≤–∫–ª—é—á–∏–º –∫–∞–º–µ—Ä—É –µ—Å–ª–∏ –ø—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫

      if (!pc) {
        pc = createPeerConnection();
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      }

      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      socket.emit("answer", answer);
    });

    socket.on("answer", async (answer) => {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on("ice-candidate", async (candidate) => {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (e) {
        console.error(e);
      }
    });

  </script>

</body>
</html>
