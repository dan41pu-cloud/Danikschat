<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danikschat</title>
  <style>
    /* === –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã === */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      background: #2f3136;
      color: white;
      margin: 0;
      padding: 10px;
      overflow-y: auto;
    }

    /* === –ë–ª–æ–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —á–∞—Ç–∞ === */
    #auth, #chat {
      background: #36393f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);

      width: 95%;        /* –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ */
      max-width: 420px;  /* –º–∞–∫—Å–∏–º—É–º –¥–ª—è –ü–ö */
      display: none;
      flex-direction: column;
      margin: 10px auto; /* —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    }

    /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫ */
    #auth.active, #chat.active { display: flex; }

    input, button {
      margin: 5px 0;
      padding: 12px;
      border: none;
      border-radius: 6px;
      width: 100%;
      font-size: 16px;
    }

    button {
      background: #5865f2;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #4752c4;
    }

    /* –ß–∞—Ç */
    ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
      word-wrap: break-word;
    }

    li {
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      background: #40444b;
      width: fit-content;
      max-width: 70%;
      word-break: break-word;
    }

    .my-message { background: #7289da; margin-left: auto; }
    .message-username { font-weight: bold; margin-bottom: 4px; }
    .message-time { font-size: 10px; text-align: right; color: gray; }

    /* –≠–º–æ–¥–∂–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
    #emojiPicker { 
      margin-top: 10px; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 6px; 
    }
    #emojiPicker button { 
      cursor: pointer; 
      padding: 6px 10px; 
      font-size: 18px; 
      flex: 1 1 20%; /* —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –∑–∞–Ω–∏–º–∞–ª–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –º–µ—Å—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
    }

    #imageInput { margin-top: 10px; }
    #clearChat { background: #f04747; }

    /* –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥ –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
    @media (max-width: 400px) {
      #auth, #chat {
        padding: 15px;
      }
      input, button {
        font-size: 14px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div id="auth" class="active">
    <h2>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button id="login">–í–æ–π—Ç–∏</button>
    <button id="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <p id="authMsg"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat">
    <h2 id="welcome"></h2>
    <ul id="messages"></ul>
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <input type="file" id="imageInput" accept="image/*" />
    <div id="emojiPicker">
      <button onclick="location.href='video.html'">üé• –í–∏–¥–µ–æ —á–∞—Ç</button>
      <button class="emoji">üòÄ</button>
      <button class="emoji">üòÇ</button>
      <button class="emoji">üòç</button>
      <button class="emoji">üòé</button>
      <button class="emoji">üëç</button>
    </div>
    <button id="clearChat">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const authDiv = document.getElementById('auth');
    const chatDiv = document.getElementById('chat');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const authMsg = document.getElementById('authMsg');
    const welcome = document.getElementById('welcome');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const imageInput = document.getElementById("imageInput");
    const emojiButtons = document.querySelectorAll(".emoji");
    const clearChatBtn = document.getElementById("clearChat");

    let username = null;
    let admin = false;

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    document.getElementById('register').onclick = () => {
      socket.emit('register', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };
    document.getElementById('login').onclick = () => {
      socket.emit('login', { username: usernameInput.value.trim(), password: passwordInput.value.trim() });
    };
    socket.on('registerSuccess', msg => authMsg.textContent = msg);
    socket.on('registerError', msg => authMsg.textContent = msg);
    socket.on('loginError', msg => authMsg.textContent = msg);
    socket.on('loginSuccess', (data) => {
      username = data.username;
      admin = data.admin;
      authDiv.classList.remove('active');
      chatDiv.classList.add('active');
      welcome.textContent = `–ü—Ä–∏–≤–µ—Ç, ${username}!`;
      data.messages.forEach(addMessage);
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
    send.onclick = () => {
      const text = input.value.trim();
      if (text) {
        socket.emit('chat message', { username, text });
        input.value = '';
      }
    };

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    function addMessage(msg) {
      const li = document.createElement('li');
      if(msg.username === username) li.classList.add('my-message');

      if(msg.text) {
        li.innerHTML = `<div class="message-username">${msg.username}</div><div>${msg.text}</div><div class="message-time">${msg.time}</div>`;
      } else if(msg.data) {
        li.innerHTML = `<div class="message-username">${msg.username}</div><img src="${msg.data}" style="max-width:200px; border-radius:8px; margin-top:4px;"><div class="message-time">${msg.time}</div>`;
      }

      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on('chat message', addMessage);
    socket.on('chat image', addMessage);

    // –≠–º–æ–¥–∂–∏
    emojiButtons.forEach(btn => {
      btn.onclick = () => {
        const emoji = btn.textContent;
        socket.emit("chat message", { username, text: emoji });
      };
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    imageInput.onchange = () => {
      const file = imageInput.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        socket.emit("chat image", { username, data: reader.result });
      };
      reader.readAsDataURL(file);
      imageInput.value = "";
    };

    // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
    clearChatBtn.onclick = () => {
      socket.emit("clear-messages");
    };
    socket.on("chat-cleared", () => {
      messages.innerHTML = "";
    });
  </script>
</body>
</html>
