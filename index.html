
    toggleVideo.onclick = () => {
      if (!localStream) return;
      videoEnabled = !videoEnabled;
      localStream.getVideoTracks().forEach(track => track.enabled = videoEnabled);
      toggleVideo.textContent = videoEnabled ? "Выключить камеру" : "Включить камеру";
    };

    toggleAudio.onclick = () => {
      if (!localStream) return;
      audioEnabled = !audioEnabled;
      localStream.getAudioTracks().forEach(track => track.enabled = audioEnabled);
      toggleAudio.textContent = audioEnabled ? "Выключить микрофон" : "Включить микрофон";
    };

    /* === ОТКЛЮЧИТЬ ВИДЕО === */
    stopVideo.onclick = () => {
      inCall = false;

      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;

      videoEnabled = true;
      audioEnabled = true;
      toggleVideo.textContent = "Выключить камеру";
      toggleAudio.textContent = "Выключить микрофон";
    };

    /* === ПРОИГРЫВАНИЕ ЗВУКА ТОЛЬКО ЕСЛИ ПОЛЬЗОВАТЕЛЬ НЕ В ЗВОНКЕ === */
    socket.on("audio-join", ({ from }) => {
      // звук проигрывается только если мы не в звонке
      if (!inCall) {
        const snd = document.getElementById("joinSound");
        snd.volume = 1;
        snd.play().catch(() => {});
      }
    });

    /* === HELPERS === */
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/[&<"']/g, function(m) {
          return ({ '&': '&amp;', '<': '&lt;', '"': '&quot;', "'": '&#039;' })[m];
        });
    }

    // При заходе на страницу запросим актуальный список онлайн
    socket.emit("get-active");

  </script>
</body>
</html>
